# 01. 사용자 수에 따른 규모 확장성

### 데이터베이스 종류

데이터 베이스는 관계형 데이터 베이스와 비관계형 데이터베이스로 나눌 수 있다. 관계형 데이터베이스는 전통적인 데이터 베이스로 열, 칼럼으로 데이터를 표현한다. 비 관계형 데이터 베이스는 NoSQL 즉, Not Only SQL의 약자로 관계형 데이터베이스보다 덜 제한적인 모델이다.

비관계형 데이터베이스는  아래의 경우에 사용된다.

* 낮은 응답 지연시간을 요구하는 경우
* 다루는 데이터가 비정형인 경우
* 데이터를 직렬화하거나 역직렬화 하는 경우
* 아주 많은 데이터를 저장할 경우



### 웹 계층

#### 서버

서버를 확장하는 개념은 두 가지의 개념이 있다. 하나는 좋은 고사양 자원을 추가하는 수직적 규모 확장(Scale Up)과 많은 서버를 추가하는 수평적 규모(Scale Out)의 방식이다.

수직적 규모의 확장의 경우 무한대로 증설할 수 없고 장애에 대한 자동복구나 다중화 방안이 제시되지 않는다. 서버의 장애가 발생하면 웹사이트/앱은 완전히 중단된다.

수평적 규모의 확장은 부하 분산기 혹은 로드밸런서라는 도입을 통해 가능하다.



#### 로드 밸런스

로드 밸런스는 부하 분산 집합에 속하는 웹 서버들에게 트래픽 부하를 고르게 분산하는 역할을 한다. 사용자는 로드밸런스의 ``public IP address`` 에 접속하고 서버 간의 통신은 ``private IP address``를 이용한다.  ``private IP address``는 서버 사이의 통신만 사용가능하고 인터넷을 통해서는 접속할 수 없다.



### 데이터베이스 계층

#### 데이터베이스 다중화

데이터 원본은 주 서버(master)에 복사본은 부 서버(slave)에 저장한다. 쓰기 연산만 마스터에서 지원하고 부 데이터베이스는 사본은 전달받고 읽기 연산만 지원한다. 

* 모든 데이터 변경은 주 데이터베이스 서버에서 처리하고 읽기 연산은 부 데이터베이스 서버들로 분산되므로 병렬로 처리될 수 있는 query의 수가 늘어나 성능이 좋아진다.
* 자연 재해 등의 이유로 데이터 베이스 서버가운데 일부가 파괴되어도 지역별로 다중화 시킬 수 있기 때문에 데이터는 보존된다. 
* 하나의 데이터베이스 서버가 장애가 발생하더라도 다른 서버의 데이터를 가져와 계속 서비스 가능하다.
  * 부 서버가 한대인데 다운되면 -> 주서버가 모든 것을 처리
  * 주 서버가 다운되면 -> 다른 부 서버가 주서버가 되고 다른 부 서버가 추가된다. 



#### 데이터베이스 규모 확장

데이터베이스의 규모를 확장하는 방법은 두 가지가 있다. 하나는 수직적 규모 확정성이고 또 다른 하나는 수평적 규모 확장성이다. 

수직적 규모 확정법은 고성능 자원(CPU, RAM, 디스크 등)을 증설하는 방법이다. 이 방법은 무한히 증설할 수 없다는 단점과 SPOF 의 위험, 그리고 비용이 많이 드는 단점을 가지고 있다.

수평적 규모 확정법은 샤딩이라고 부르는데 데이터 베이스를 샤드라고하는 작은 단위로 분할하는 기술을 말한다. 

샤딩을 구현할 때 가장 중요한 것은 샤딩 키(파티션 키)를 어떻게 정하느냐하는 것이다. 

샤딩의 문제점은 아래와 같다.

1. 데이터의 재 샤딩 : 만약 데이터가 너무 많아져 하나의 샤드로 감당하기 어렵거나 샤드 간의 분포가 균등하지 못해 특정 샤드의 공간 소모가 다른 샤드에 비해 빠르게 진행될때 -> 이 현상이 발생할 경우 샤드 키를 변경하여 데이터를 재배치해야한다.
2. 유명인사(핫스판 키) 특정 샤드에 질의가 집중되어 서버에 과부하가 걸리는 문제이다. 
3. 조인과 비정규화 : 데이터 베이스를 여러 샤드로 분리하고 나면 다시 조인하기 힘들어진다. 이를 해결하는 방법은 비정규화를 통해 하나의 테이블에서 질의를 수행될 수 있도록 하는 것이다.



### 응답시간 줄이기

#### 1. 캐시

값 비싼 연산 결과 또는 자주 참조되는 데이터를 저장하여 메모리나 데이터 베이스를 걸치지 않고 빠르게 응답할 수 있는 저장소이다.

캐시는 데이터 베이스보다 훨씬 빠르기 때문에 성능이 개선된다.

보통 요청 받은 웹 서버는 캐시에 응답이 저장되었는지를 보고 저장되어있으면 데이터를 클라이언트에게 반환한다. 없는 경우에는 query를 통해 데이터를 찾아 캐시에 저장하고 클라이언트에게 반환한다. (읽기 주도형 캐시 전략)

#### 캐시 유의할 점

1. 캐시는 ```갱신은 자주 일어나지 않지만 참조는 빈번하게 일어나는 경우```에 적합하다.
2. 캐시는 휘발성 메모리를 사용하므로 지속적 저장소로는 적합하지 않다.
3. 만료된 데이터는 캐시에 삭제해야하는 만료정책을 두어야한다.
4. ``일관성`` : 저장소의 원본은 갱신하는 연산과 캐시를 갱신하는 연산이 단일 트랙잭션으로 처리되지 않는 경우 일관성이 깨질 우려가 있다.
5. 캐시 서버가 한 대 두는 경우 단일 장애 지점 즉, SPOF(single point of Failure) 전체 시스템 동작이 중단되는 경우가 생길 수 있어서 여러 지역에 걸쳐 캐시를 분산해야한다.
6. 캐시의 크기를 적당히 지정해야한다.
7. 데이터 방출은 어떻게 할 것인가? LRU, LFU... etc



#### 2. 콘텐츠 전송 네트워크(CDN)

``정적 콘텐츠``를 전송하는데 쓰이는 지리적으로 분산된 서버의 네트워크이다. 이미지, 비디오, CSS, javascript 등을 캐시할 수 있다.

CDN는 보통 제 3자 사업자에 의해 운영되고 데이터 전송양에 따라 요금이 부과된다. 적절한 만료 시한을 결정하고 CDN이 죽었을 때 웹어플리케이션이 어떻게 동작할지 고려해야한다. 

* CDN이 응답하지 않는 경우 해당 문제를 감지하여 원본 서버로부터 직접 콘텐츠롤 가져오도록 클라이언트를 구성

콘텐츠 무효화 방법을 설정해야한다. 

1. CDN 서비스 사업자가 제공하는 API 사용으로 무효화
2. 콘텐츠 버전을 주어 (object versioning) 이용

CDN을 사용하면 정적 콘텐츠는 더 이상 웹 서버에서 ``서비스 하지 않으며`` 더 나은 성능을 보장한다. 그리고 캐시가 데이터 베이스의 부하를 줄여준다.



### 무상태 (StateLess)

특정 사용자 A가 서버1의 상태 정보를 보관하고 있을 경우 사용자 A의 정보는 서버2에 존재하지 않는다. 이것을 의존적인 아키텍처라고 한다. 이 경우 로드 밸런스 설정을 통해 고정 세션 (사용자 A는 서버 1에서만 처리하도록)을 설정해야 한다. 이 방법은 로드 밸런스에게 부담을 주며 로드 밸런드 뒷단의 서버를 추가하거나 제거하는 것도 어려워진다.

또 다른 방법은 ``공유 저장소``를 사용하는 방법이다. 이 방법은 상태 정보를 웹서버로부터 물리적으로 분리하여 단순하고 안정적이고 규모 확장성이 쉽다. 여기서 공유 저장소는 Memcached/Redis 같은 캐시 시스템일 수 있고 혹은 NoSQL일 수도 있다.



### 데이터 센터

다중 데이터 센터를 만들 때 주의할 점

1. 트래픽 우화 : 올바은 데이터 센터로 트래픽을 보내는 효과적인 방법을 찾아야 한다. 예를 들어, GeoDNS는 사용자에게 가장 가까운 데이터 센터로 트래픽을 보낼 수 있도록 해준다.
2. 데이터 동기화 : 데이터 센터마다 데이터베이스가 다르다면 데이터 동기화에 주의해야한다. 보편적 전략은 데이터를 여러 데이터 센터에 걸쳐 다중화하는 것이다.
3. 테스트와 배포 : 웹 사이트 또는 어플리케이션을 여러 위치에서 테스트해 보는 것이 중요하다. 



### 메시지 큐

메시지 큐는 일단 보관한 메세지는 소비자가 꺼낼 때까지 안전히 보관된다는 ``무손실``특성을 보장하는 비동기 통신 지원 컴포넌트이다. 

메시지 큐는 서버 간의 결합이 느슨해져서 규모 확장성이 보장되는 안정적 어플리케이션을 구성하기 좋다.

생산자는 소비자 프로세스가 다운되어도 메시지를 발행할 수 있고, 소비자는 생상자 프로세스가 가용한 상태가 아니여도 메시지를 수신할 수 있다.



### 정리

```
1. 웹 계층은 무상태 계층으로
2. 모든 계층은 다중화 도입
3. 가능한 많은 데이터를 캐시
4. 여러 데이터 세터를 지원
5. 정적 콘텐츠는 CDN을 통해 서비스
6. 데이터 계층은 샤딩을 통해 규모 확장
7. 각 계층은 독립적 서비스로 분할
8. 시스템을 지속적으로 모니터링하고, 자동화 도구 활용
```

